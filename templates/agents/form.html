{% extends 'base.html' %}

{% block title %}{% if agent %}Editar{% else %}Criar{% endif %} Agente - PanDia{% endblock %}
{% block page_title %}{% if agent %}Editar Agente{% else %}Criar Agente{% endif %}{% endblock %}

{% block content %}
<a href="{% url 'agents:list' %}" class="back-link">
    ‚Üê Voltar para agentes
</a>

<div class="card">
    <h2 class="content-title">{% if agent %}Editar Agente{% else %}Criar Novo Agente{% endif %}</h2>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Basic Information -->
        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; margin-top: 1.5rem;">Informa√ß√µes B√°sicas</h3>
        
        {% if not agent %}
        <div class="form-group">
            <label class="form-label" for="organization">Organiza√ß√£o</label>
            <select name="organization" id="organization" class="form-select" required>
                <option value="">Selecione a organiza√ß√£o...</option>
                {% for org in organizations %}
                <option value="{{ org.id }}">{{ org.name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        
        <div class="form-group">
            <label class="form-label" for="name">Nome do Agente</label>
            <input 
                type="text" 
                name="name" 
                id="name" 
                class="form-input"
                value="{% if agent %}{{ agent.name }}{% endif %}"
                placeholder="Bot de Atendimento ao Cliente"
                required
            >
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="role">Fun√ß√£o</label>
                <select name="role" id="role" class="form-select" required>
                    <option value="atendente" {% if agent.role == 'atendente' %}selected{% endif %}>atendente</option>
                    <option value="recepcionista" {% if agent.role == 'recepcionista' %}selected{% endif %}>recepcionista</option>
                    <option value="consultor" {% if agent.role == 'consultor' %}selected{% endif %}>consultor</option>
                    <option value="vendedor" {% if agent.role == 'vendedor' %}selected{% endif %}>vendedor</option>
                    <option value="suporte" {% if agent.role == 'suporte' %}selected{% endif %}>suporte</option>
                    <option value="assistente" {% if agent.role == 'assistente' %}selected{% endif %}>assistente</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="sector">Setor</label>
                <select name="sector" id="sector" class="form-select">
                    <option value="">Selecione o setor...</option>
                    <option value="beleza" {% if agent.sector == 'beleza' %}selected{% endif %}>beleza</option>
                    <option value="saude" {% if agent.sector == 'saude' %}selected{% endif %}>saude</option>
                    <option value="vendas" {% if agent.sector == 'vendas' %}selected{% endif %}>vendas</option>
                    <option value="atendimento" {% if agent.sector == 'atendimento' %}selected{% endif %}>atendimento</option>
                    <option value="tecnologia" {% if agent.sector == 'tecnologia' %}selected{% endif %}>tecnologia</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="language">Idioma</label>
                <select name="language" id="language" class="form-select" required>
                    <option value="pt-BR" {% if agent.language == 'pt-BR' %}selected{% endif %}>pt-BR</option>
                    <option value="en-US" {% if agent.language == 'en-US' %}selected{% endif %}>en-US</option>
                    <option value="es-ES" {% if agent.language == 'es-ES' %}selected{% endif %}>es-ES</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="tone">Tom de Voz</label>
                <select name="tone" id="tone" class="form-select" required>
                    <option value="profissional_formal" {% if agent.tone == 'profissional_formal' %}selected{% endif %}>Profissional e Formal</option>
                    <option value="amigavel_casual" {% if agent.tone == 'amigavel_casual' %}selected{% endif %}>Amig√°vel e Casual</option>
                    <option value="objetivo_direto" {% if agent.tone == 'objetivo_direto' %}selected{% endif %}>Objetivo e Direto</option>
                    <option value="simpatico_acolhedor" {% if not agent or agent.tone == 'simpatico_acolhedor' %}selected{% endif %}>Simp√°tico e Acolhedor</option>
                    <option value="energetico_entusiasmado" {% if agent.tone == 'energetico_entusiasmado' %}selected{% endif %}>Energ√©tico e Entusiasmado</option>
                    <option value="calmo_paciente" {% if agent.tone == 'calmo_paciente' %}selected{% endif %}>Calmo e Paciente</option>
                    <option value="tecnico_detalhista" {% if agent.tone == 'tecnico_detalhista' %}selected{% endif %}>T√©cnico e Detalhista</option>
                    <option value="consultivo_educativo" {% if agent.tone == 'consultivo_educativo' %}selected{% endif %}>Consultivo e Educativo</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="status">Status</label>
            <select name="status" id="status" class="form-select" required>
                <option value="Ativo" {% if agent.status == 'Ativo' %}selected{% endif %}>Ativo</option>
                <option value="Inativo" {% if agent.status == 'Inativo' %}selected{% endif %}>Inativo</option>
                <option value="Em Manuten√ß√£o" {% if agent.status == 'Em Manuten√ß√£o' %}selected{% endif %}>Em Manuten√ß√£o</option>
            </select>
        </div>
        
        <!-- Messages -->
        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; margin-top: 2rem;">Mensagens</h3>
        
        <div class="form-group">
            <label class="form-label" for="greeting">Mensagem de Sauda√ß√£o</label>
            <textarea 
                name="greeting" 
                id="greeting" 
                class="form-textarea"
                placeholder="Ol√°! Como posso ajud√°-lo?"
            >{% if agent %}{{ agent.greeting }}{% else %}Ol√° {{cliente_nome}}! Eu sou {{agente_nome}}. Como posso te ajudar hoje?{% endif %}</textarea>
            <small class="form-helper" style="display: block; margin-top: 0.5rem; color: var(--gray-500); font-size: 0.875rem;">üí° Use <code style="background: var(--gray-100); padding: 0.125rem 0.375rem; border-radius: 0.25rem;">{% verbatim %}{{cliente_nome}}{% endverbatim %}</code> e <code style="background: var(--gray-100); padding: 0.125rem 0.375rem; border-radius: 0.25rem;">{% verbatim %}{{agente_nome}}{% endverbatim %}</code> para personaliza√ß√£o din√¢mica</small>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="out_of_hours_message">Mensagem Fora do Hor√°rio</label>
            <textarea 
                name="out_of_hours_message" 
                id="out_of_hours_message" 
                class="form-textarea"
                placeholder="Estamos fora do hor√°rio de atendimento. Deixe sua mensagem!"
            >{% if agent %}{{ agent.out_of_hours_message }}{% endif %}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="fallback_message">Mensagem Alternativa</label>
            <textarea 
                name="fallback_message" 
                id="fallback_message" 
                class="form-textarea"
                placeholder="Desculpe, n√£o entendi. Pode reformular?"
            >{% if agent %}{{ agent.fallback_message }}{% endif %}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="escalation_rule">Regra de Escalonamento</label>
            <textarea 
                name="escalation_rule" 
                id="escalation_rule" 
                class="form-textarea"
                placeholder="Transferir para atendente humano quando cliente solicitar."
            >{% if agent %}{{ agent.escalation_rule }}{% else %}Transferir para atendente humano quando cliente solicitar.{% endif %}</textarea>
            <small class="form-helper" style="display: block; margin-top: 0.5rem; color: var(--gray-500); font-size: 0.875rem;">Quando e como transferir para atendimento humano</small>
        </div>
        
        <!-- Advanced Settings -->
        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; margin-top: 2rem;">Configura√ß√µes Avan√ßadas</h3>
        
        <div class="form-group">
            <label class="form-label" for="transfer_keywords">Palavras-chave de Transfer√™ncia (separadas por v√≠rgula)</label>
            <input 
                type="text" 
                name="transfer_keywords" 
                id="transfer_keywords" 
                class="form-input"
                value="{% if agent %}{{ agent.transfer_keywords }}{% endif %}"
                placeholder="falar com gerente, gerente, supervisor"
            >
        </div>
        
        <div class="form-group">
            <label class="form-label" for="style_guidelines">Diretrizes de Estilo</label>
            <textarea 
                name="style_guidelines" 
                id="style_guidelines" 
                class="form-textarea"
                placeholder="Sempre ser educado, usar emojis com modera√ß√£o..."
            >{% if agent %}{{ agent.style_guidelines }}{% endif %}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="knowledge_base">Base de Conhecimento (Markdown)</label>
            <textarea 
                name="knowledge_base" 
                id="knowledge_base" 
                class="form-textarea"
                style="min-height: 150px;"
                placeholder="# Base de Conhecimento\n\n## FAQ\n\n..."
            >{% if agent %}{{ agent.knowledge_base }}{% endif %}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="knowledge_pdf">PDF de Base de Conhecimento</label>
            <input type="file" name="knowledge_pdf" id="knowledge_pdf" class="form-input" accept=".pdf">
            {% if agent and agent.knowledge_pdf %}
            <div style="margin-top: 0.75rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem; color: #92400e;">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span style="font-weight: 500;">{{ agent.knowledge_pdf.name }}</span>
            </div>
            {% endif %}
            <small class="form-helper" style="display: block; margin-top: 0.5rem; color: var(--gray-500); font-size: 0.875rem;">üìÑ O PDF ser√° enviado automaticamente para o N8N quando salvar</small>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="n8n_webhook_url">N8N Webhook URL</label>
            <input 
                type="url" 
                name="n8n_webhook_url" 
                id="n8n_webhook_url" 
                class="form-input"
                value="{% if agent %}{{ agent.n8n_webhook_url }}{% endif %}"
                placeholder="https://n8n.example.com/webhook/..."
            >
        </div>
        
        <div class="form-group">
            <label class="form-label" for="max_response_time">Tempo M√°ximo de Resposta (segundos)</label>
            <input 
                type="number" 
                name="max_response_time" 
                id="max_response_time" 
                class="form-input"
                value="{% if agent %}{{ agent.max_response_time }}{% else %}30{% endif %}"
                min="5"
                max="300"
            >
        </div>
        
        <!-- Actions -->
        <div style="display: flex; gap: 0.75rem; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--gray-200);">
            <button type="submit" class="btn btn-primary">
                {% if agent %}Atualizar{% else %}Criar{% endif %}
            </button>
            <a href="{% url 'agents:list' %}" class="btn btn-secondary">
                Cancelar
            </a>
        </div>
    </form>
</div>
{% endblock %}
