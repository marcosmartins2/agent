{% extends 'base.html' %}

{% block title %}Documenta√ß√£o da API - PanDia{% endblock %}
{% block page_title %}Documenta√ß√£o da API{% endblock %}

{% block content %}
<style>
    :root {
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.5rem;
        --space-6: 2rem;
        --radius-md: 8px;
        --radius-lg: 12px;
    }
    
    .api-section {
        margin-bottom: 2rem;
    }
    
    .api-card {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .api-card-highlight {
        border-left: 4px solid #f59e0b;
        background: linear-gradient(135deg, rgba(251, 146, 60, 0.05) 0%, rgba(249, 115, 22, 0.02) 100%);
    }
    
    .api-endpoint-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        color: white;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }
    
    .code-block {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1.5rem;
        border-radius: var(--radius-md);
        overflow-x: auto;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.875rem;
        line-height: 1.7;
        border: 1px solid #334155;
    }
    
    .code-inline {
        background: #fef3c7;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        color: #92400e;
        font-family: 'Consolas', monospace;
        font-weight: 600;
        font-size: 0.9em;
    }
    
    .info-box {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 1rem 1.25rem;
        border-radius: var(--radius-md);
        margin: 1rem 0;
    }
    
    .param-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .param-table thead {
        background: #f97316;
        color: white;
    }
    
    .param-table th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 600;
    }
    
    .param-table td {
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--gray-200);
        color: var(--gray-700);
    }
    
    .param-table tbody tr:nth-child(even) {
        background: #fafafa;
    }
    
    .n8n-config-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
        border-left: 4px solid #f59e0b;
        padding: 1.5rem;
        border-radius: var(--radius-md);
        margin: 1rem 0;
    }
    
    .config-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .config-item:last-child {
        margin-bottom: 0;
    }
    
    .config-label {
        color: #92400e;
        font-weight: 600;
        min-width: 140px;
    }
    
    .config-value {
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-family: monospace;
        flex: 1;
        word-break: break-all;
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.9rem;
        display: inline-block;
    }
    
    .status-success {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-warning {
        background: #fef3c7;
        color: #92400e;
    }
    
    .status-error {
        background: #fee2e2;
        color: #991b1b;
    }
</style>

<div style="max-width: 1200px; margin: 0 auto;">
    <!-- Header -->
    <div style="margin-bottom: 2.5rem;">
        <h1 style="font-size: 2rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b, #ea8a08); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                </svg>
            </div>
            Documenta√ß√£o da API
        </h1>
        <p style="font-size: 1.125rem; color: var(--gray-600); margin-left: 60px;">
            Integre seus agentes com N8N, Zapier e outras ferramentas
        </p>
    </div>

    <!-- Autentica√ß√£o -->
    <div class="api-card api-card-highlight">
        <h2 style="color: #ea580c; margin-bottom: 1rem; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
            <svg width="28" height="28" fill="none" stroke="#f59e0b" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
            </svg>
            Autentica√ß√£o
        </h2>
        <p style="color: var(--gray-700); line-height: 1.6; margin-bottom: 1.5rem;">
            Todas as requisi√ß√µes requerem autentica√ß√£o via <strong>API Key</strong>. Adicione o header abaixo em todas as requisi√ß√µes:
        </p>
        
        <div class="code-block" style="margin-bottom: 1.5rem;">
            <div style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.5rem;">Header:</div>
            <code style="color: #22d3ee;">X-API-Key: <span style="color: #fbbf24;">SUA_API_KEY_AQUI</span></code>
        </div>

        <div class="info-box">
            <strong style="color: #92400e;">üí° Onde encontrar sua API Key?</strong>
            <p style="margin: 0.5rem 0 0 0; color: #713f12;">
                Acesse <a href="{% url 'organizations:apikeys' %}" style="color: #f59e0b; font-weight: 600; text-decoration: underline;">Padaria ‚Üí API Keys</a> para criar e gerenciar suas chaves de acesso.
            </p>
        </div>
        
        <div style="background: #ede9fe; border-left: 4px solid #8b5cf6; padding: 1rem 1.25rem; border-radius: var(--radius-md); margin-top: 1rem;">
            <strong style="color: #6b21a8;">üîí Permiss√µes por Agente</strong>
            <p style="margin: 0.5rem 0 0 0; color: #6b21a8;">
                Cada API Key pode ser configurada para ter acesso a <strong>todos os agentes</strong> da padaria ou apenas a <strong>um agente espec√≠fico</strong>. 
                Se tentar acessar um agente sem permiss√£o, receber√° um erro <code style="background: #fef3c7; padding: 2px 6px; border-radius: 4px; color: #92400e;">403 Forbidden</code>.
            </p>
        </div>
    </div>

    <!-- Endpoint 1: Config -->
    <div class="api-card api-section">
        <div class="api-endpoint-badge">
            GET
        </div>
        <h2 style="font-family: 'Consolas', monospace; font-size: 1.25rem; font-weight: 600; color: var(--gray-900); margin-bottom: 1rem;">
            /api/n8n/agents/&lt;slug&gt;/config
        </h2>
        <p style="color: var(--gray-600); line-height: 1.6; margin-bottom: 1.5rem;">
            Retorna a configura√ß√£o b√°sica do agente <strong>(sem knowledge_base)</strong>. Use para buscar configura√ß√µes frequentemente sem carregar dados pesados.
        </p>

        <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin: 1.5rem 0 0.75rem;">üîó URL Completa</h3>
        <div class="code-block">
            <code style="color: #22d3ee; word-break: break-all;">{{ request.scheme }}://{{ request.get_host }}/api/n8n/agents/<span style="color: #fbbf24;">SEU-AGENTE-SLUG</span>/config</code>
        </div>

        <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin: 1.5rem 0 0.75rem;">üìã Par√¢metros</h3>
        <table class="param-table">
            <thead>
                <tr>
                    <th style="width: 25%;">Nome</th>
                    <th style="width: 20%;">Tipo</th>
                    <th>Descri√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code class="code-inline">slug</code></td>
                    <td>Path</td>
                    <td>Slug √∫nico do agente (identificador na URL)</td>
                </tr>
            </tbody>
        </table>

        <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin: 1.5rem 0 0.75rem;">‚öôÔ∏è Configura√ß√£o no N8N</h3>
        <div class="n8n-config-box">
            <div class="config-item">
                <div class="config-label">Method:</div>
                <div class="config-value" style="color: #059669; font-weight: 600;">GET</div>
            </div>
            <div class="config-item">
                <div class="config-label">URL:</div>
                <div class="config-value" style="font-size: 0.85rem;">{{ request.scheme }}://{{ request.get_host }}/api/n8n/agents/&#123;&#123;$json["agent_slug"]&#125;&#125;/config</div>
            </div>
            <div class="config-item">
                <div class="config-label">Authentication:</div>
                <div class="config-value" style="color: #6366f1; font-weight: 600;">Generic Credential Type</div>
            </div>
            <div class="config-item">
                <div class="config-label">Header Name:</div>
                <div class="config-value" style="color: #dc2626; font-weight: 600;">X-API-Key</div>
            </div>
            <div class="config-item">
                <div class="config-label">Header Value:</div>
                <div class="config-value">SUA_API_KEY</div>
            </div>
        </div>

        <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin: 1.5rem 0 0.75rem;">üìÑ Exemplo de Resposta</h3>
        <pre class="code-block"><code>{
  <span style="color: #22d3ee;">"name"</span>: <span style="color: #fbbf24;">"Maria Atendente"</span>,
  <span style="color: #22d3ee;">"slug"</span>: <span style="color: #fbbf24;">"maria-atendente"</span>,
  <span style="color: #22d3ee;">"role"</span>: <span style="color: #fbbf24;">"atendente"</span>,
  <span style="color: #22d3ee;">"sector"</span>: <span style="color: #fbbf24;">"padaria"</span>,
  <span style="color: #22d3ee;">"language"</span>: <span style="color: #fbbf24;">"pt-BR"</span>,
  <span style="color: #22d3ee;">"greeting"</span>: <span style="color: #fbbf24;">"Ol√°! Como posso ajudar?"</span>,
  <span style="color: #22d3ee;">"tone"</span>: <span style="color: #fbbf24;">"amigavel"</span>,
  <span style="color: #22d3ee;">"fallback_message"</span>: <span style="color: #fbbf24;">"Desculpe, n√£o entendi..."</span>
}</code></pre>
    </div>

    <!-- Endpoint 2: Knowledge -->
    <div class="api-card api-section">
        <div class="api-endpoint-badge">
            GET
        </div>
        <h2 style="font-family: 'Consolas', monospace; font-size: 1.25rem; font-weight: 600; color: var(--gray-900); margin-bottom: 1rem;">
            /api/n8n/agents/&lt;slug&gt;/knowledge
        </h2>
        <p style="color: var(--gray-600); line-height: 1.6; margin-bottom: 1.5rem;">
            Retorna a <strong>base de conhecimento completa</strong> do agente, incluindo texto extra√≠do de PDFs. ‚ö†Ô∏è Pode ser um payload grande.
        </p>

        <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin: 1.5rem 0 0.75rem;">üîó URL Completa</h3>
        <div class="code-block">
            <code style="color: #22d3ee; word-break: break-all;">{{ request.scheme }}://{{ request.get_host }}/api/n8n/agents/<span style="color: #fbbf24;">SEU-AGENTE-SLUG</span>/knowledge</code>
        </div>

        <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin: 1.5rem 0 0.75rem;">üìÑ Exemplo de Resposta</h3>
        <pre class="code-block"><code>{
  <span style="color: #22d3ee;">"slug"</span>: <span style="color: #fbbf24;">"maria-atendente"</span>,
  <span style="color: #22d3ee;">"knowledge_base"</span>: <span style="color: #fbbf24;">"## Produtos\\n\\n- P√£o: R$ 0,50\\n- Bolo: R$ 35,00\\n..."</span>,
  <span style="color: #22d3ee;">"has_pdf"</span>: <span style="color: #34d399;">true</span>,
  <span style="color: #22d3ee;">"updated_at"</span>: <span style="color: #fbbf24;">"2025-12-11T12:30:00Z"</span>
}</code></pre>
    </div>

    <!-- Webhook -->
    <div class="api-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(99, 102, 241, 0.02) 100%); border-left: 4px solid #8b5cf6;">
        <h2 style="color: #7c3aed; margin-bottom: 1rem; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
            <svg width="28" height="28" fill="none" stroke="#8b5cf6" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            Webhook de Notifica√ß√£o
        </h2>
        <p style="color: var(--gray-700); line-height: 1.6; margin-bottom: 1.5rem;">
            Configure um webhook do N8N no seu agente para receber notifica√ß√µes autom√°ticas quando o agente for atualizado (principalmente quando um PDF for carregado).
        </p>

        <div style="background: white; padding: 1.5rem; border-radius: var(--radius-md); border: 1px solid var(--gray-200);">
            <h3 style="font-size: 1rem; font-weight: 600; color: #7c3aed; margin-bottom: 1rem;">üîÑ Como Configurar</h3>
            <ol style="padding-left: 1.25rem; color: var(--gray-700); line-height: 1.8; margin: 0;">
                <li style="margin-bottom: 0.5rem;">Crie um webhook no N8N (ex: <code class="code-inline">https://seu-n8n.com/webhook/agent-updated</code>)</li>
                <li style="margin-bottom: 0.5rem;">Edite seu agente e cole a URL no campo <strong>"Webhook N8N"</strong></li>
                <li style="margin-bottom: 0.5rem;">Quando o agente for atualizado, voc√™ receber√° um POST com o payload abaixo</li>
                <li>Use essa notifica√ß√£o para buscar <code class="code-inline">/knowledge</code> e atualizar seu RAG</li>
            </ol>
        </div>

        <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin: 1.5rem 0 0.75rem;">üìÑ Payload Enviado (POST)</h3>
        <pre class="code-block"><code>{
  <span style="color: #22d3ee;">"agent_slug"</span>: <span style="color: #fbbf24;">"maria-atendente"</span>,
  <span style="color: #22d3ee;">"has_pdf"</span>: <span style="color: #34d399;">true</span>,
  <span style="color: #22d3ee;">"updated_at"</span>: <span style="color: #fbbf24;">"2025-12-11T12:30:00Z"</span>
}</code></pre>
    </div>

    <!-- Rate Limiting -->
    <div style="background: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);">
        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            ‚ö° Rate Limiting
        </h3>
        <p style="margin: 0; opacity: 0.95;">
            Limite de <strong style="font-size: 1.15rem;">60 requisi√ß√µes por minuto</strong> por IP/organiza√ß√£o.
        </p>
    </div>

    <!-- C√≥digos de Status -->
    <div class="api-card">
        <h2 style="color: #ea580c; margin-bottom: 1.25rem; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
            <svg width="28" height="28" fill="none" stroke="#f59e0b" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            C√≥digos de Status HTTP
        </h2>
        <table class="param-table">
            <thead>
                <tr>
                    <th style="width: 35%;">C√≥digo</th>
                    <th>Descri√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="status-badge status-success">200 OK</span></td>
                    <td>Sucesso! Dados retornados corretamente.</td>
                </tr>
                <tr>
                    <td><span class="status-badge status-warning">401 Unauthorized</span></td>
                    <td>API Key inv√°lida ou n√£o fornecida.</td>
                </tr>
                <tr>
                    <td><span class="status-badge status-warning">403 Forbidden</span></td>
                    <td>API Key v√°lida, mas sem permiss√£o para acessar este agente.</td>
                </tr>
                <tr>
                    <td><span class="status-badge status-error">404 Not Found</span></td>
                    <td>Agente n√£o encontrado ou inativo.</td>
                </tr>
                <tr>
                    <td><span class="status-badge status-error">429 Too Many Requests</span></td>
                    <td>Limite de requisi√ß√µes excedido. Aguarde antes de tentar novamente.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
